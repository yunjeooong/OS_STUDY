
# 32장: 병행성 버그 개요

동시 실행 환경에서 자주 발생하는 버그들을 살펴보겠다.  
특히 **비-교착 상태 오류**와 **교착 상태 오류**를 중심으로 정리.

---

## 32.1 오류 분류

- **비-교착 상태 오류 (Non-deadlock bugs)**
  - 원자성 위반 (Atomicity Violation)
  - 순서 위반 (Order Violation)
- **교착 상태 오류 (Deadlock Bugs)**

---

## 32.2 비-교착 상태 오류

### 원자성 위반 (Atomicity Violation)

여러 연산을 하나의 단위(원자적 블록)처럼 보호하지 않으면, 중간에 다른 쓰레드가 끼어들어 잘못된 동작이 발생할 수 있다. 예:

```c
// Thread 1
if (thd->proc_info) {
    fputs(thd->proc_info, ...);
}

// Thread 2
thd->proc_info = NULL;
```

Thread 1이 `proc_info` 존재 여부를 확인하고 `fputs()` 호출 전까지 실행된 사이에  
Thread 2가 `proc_info`를 `NULL`로 변경하면, Thread 1이 `NULL` 포인터를 참조하게 된다.  
해결책: 검사와 사용을 하나의 락(lock)으로 감싸 원자적으로 수행해야 한다.

### 순서 위반 (Order Violation)

초기화나 설정이 완료되기 전의 변수를 사용하면 예상치 못한 오류가 생긴다. 예:

```c
// Thread 1
void init() {
    mThread = PR_CreateThread(mMain, ...);
}

// Thread 2
void mMain(...) {
    mState = mThread->State;
}
```

Thread 2가 `mThread`가 초기화된 뒤에 실행된다고 가정하지만,  
Thread 1이 아직 `mThread`를 설정하지 않았다면 `NULL` 참조가 발생한다.  
해결책: **컨디션 변수** 등을 사용해 쓰레드 간 순서를 보장해야 한다.

> **포인트**: 비-교착 상태 오류는 전체 동시성 버그 중 상당 부분을 차지하므로, 우선적으로 다루어야 한다.

---

## 32.3 교착 상태 오류

교착 상태는 여러 쓰레드가 서로가 점유한 자원을 기다리며 무한 대기하는 현상이다.  
자원 의존성 그래프에 사이클(cycle)이 있으면 교착 상태가 발생할 수 있다.

### 교착 상태 발생 4가지 조건

1. **상호 배제 (Mutual Exclusion)**
   한 번에 하나의 쓰레드만 자원을 독점한다.
2. **점유 및 대기 (Hold-and-Wait)**
   자원을 점유한 채로 다른 자원을 기다린다.
3. **비선점 (No Preemption)**
   이미 점유된 자원을 강제로 회수할 수 없다.
4. **환형 대기 (Circular Wait)**
   쓰레드들이 순환 형태로 서로가 점유한 자원을 기다린다.

### 교착 상태 예방 기법

- **자원 획득 순서 지정**  
  전체 자원에 대해 총체적 또는 부분적 순서를 정해 순환 대기를 차단.
- **원자적 자원 요청**  
  필요한 모든 자원을 한 번에 요청하여 부분적 점유 상태를 제거.
- **비선점 완화**  
  자원 점유 시 강제 회수를 허용하는 인터페이스 설계(단, 복잡도 증가).
- **락-프리(lock-free) 자료구조**  
  상호 배제를 제거하고 경쟁 조건을 해결하는 방법.

### 교착 상태 회피 및 복구

- **회피 (Avoidance)**  
  스케줄링 시 잠재적 교착 상태를 분석하여 자원 할당을 통제.
- **검출 & 복구 (Detection & Recovery)**  
  교착 상태를 허용한 뒤 주기적으로 검사하고, 타임아웃·프로세스 중지 등으로 해제.

---

## 32.4 요약

- **비-교착 상태 오류**  
  - 원자성 위반, 순서 위반 등  
  - 자원 접근 타이밍 문제로 빈번하지만 수정이 비교적 쉽다.  
- **교착 상태 오류**  
  - 네 가지 조건(상호 배제·점유 및 대기·비선점·환형 대기)이 동시에 만족될 때 발생  
  - 예방(락 순서 지정, 회피) 또는 검출·복구 전략이 필요하다.